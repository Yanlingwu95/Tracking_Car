<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- PAGE TITLE -->
<title>Home</title>

<!-- ===================================
	FAVICON ICON
==================================== -->
<link rel="shortcut icon" href="images/favicon.ico">

<!-- ===================================
	NORMALIZE CSS
==================================== -->
<link rel="stylesheet" href="css/normalize.css">

<!-- ===================================
	BOOTSTRAP
==================================== -->
<link rel="stylesheet" href="css/bootstrap.min.css">

<!-- ===================================
	GOOGLE FONTS
==================================== -->
<link href='http://fonts.googleapis.com/css?family=Montserrat:400,700' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Raleway:600,700,400,300' rel='stylesheet' type='text/css'>

<!-- ===================================
	FONTS ICON
==================================== -->
<link rel="stylesheet" href="css/font-awesome/css/font-awesome.css">

<!-- ===================================
	PLUGIN
==================================== -->
<link rel="stylesheet" href="css/magnific-popup.css">
<link rel="stylesheet" href="css/slider-pro.css">
<link rel="stylesheet" href="css/owl.carousel.css">
<link rel="stylesheet" href="css/owl.theme.css">
<link rel="stylesheet" href="css/owl.transitions.css">
<link rel="stylesheet" href="css/animate.css">

<!-- ===================================
	MAIN STYLESHEET
==================================== -->
<link rel="stylesheet" href="css/main.css">
<link rel="stylesheet" href="css/responsive.css" />
<link rel="stylesheet" href="css/color-green.css" id="colors" />



<!--[if lt IE 9]>
	<script src="js/html5shiv.min.js"></script>
	<script src="js/respond.min.js"></script>
	<script type="text/javascript" src="js/selectivizr-min.js"></script>
	<script src="http://s3.amazonaws.com/nwapi/nwmatcher/nwmatcher-1.2.5-min.js"></script>
	<script src="http://css3-mediaqueries-js.googlecode.com/files/css3-mediaqueries.js"></script>
	<script src="http://ie7-js.googlecode.com/svn/version/2.1(beta4)/IE9.js"></script>
<![endif]-->
	<script type="text/javascript" src="http://latex.codecogs.com/latexit.js"></script>
	<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async>
		</script>
</head>

<body>
<!-- ===================================
	PRELOADER
==================================== -->
<div class="preloader">
	<div class="status"></div>
</div>

<!-- ===================================
	HEADER
==================================== -->
<header>
	<!-- Navigation Menu start-->
	<nav class="navbar clean-main-menu" role="navigation">
		<div class="container">

			<!-- Navbar Toggle -->
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>

				<!-- Logo -->
				<!-- comment the logo -->
				<a class="navbar-brand" href="index.html"><img class="logo" id="logo" src="images/cornell_logo_small.png" alt="Page"></a>


			</div>
			<!-- Navbar Toggle End -->

			<!-- navbar-collapse start-->
			<div id="nav-menu" class="navbar-collapse collapse" role="navigation">
				<ul class="nav navbar-nav clean-menu-wrapper">
					<li class="active">
						<a href="#clean-slider">Home</a>
					</li>
					<li>
						<a href="#objective">Objective</a>
					</li>
					<li>
						<a href="#about">Introduction</a>
					</li>
					<li>
						<a href="#featured-works">Design</a>
					</li>
					<li>
						<a href="#offer"> Testing and Issue </a>
					</li>
					<li>
						<a href="#pricing">Conclusion</a>
					</li>
					<li>
						<a href="#testimonial">Future Work</a>
					</li>
					<li>
						<a href="#contact">Appendix</a>
					</li>
				</ul>
			</div>
			<!-- navbar-collapse end-->

		</div>
	</nav>
	<!-- Navigation Menu end-->
</header>


<!-- ===================================
	MAIN SLIDER
==================================== -->
<section class="slider-pro clean-slider" id="clean-slider">
	<div class="sp-slides">

		<!-- Slides -->
		<div class="sp-slide clean-main-slides">
			<div class="clean-img-overlay"></div>

			<img class="sp-image" src="images/slider/car1.jpg" alt="Slider 1"/>
			<h1 class="sp-layer clean-slider-text-big" data-position="center" data-show-transition="right" data-hide-transition="right" data-show-delay="1500" data-hide-delay="200"> <span class="clean-color-contras">Autonomous Tracking Robot</span>  </h1>
			<p class="sp-layer"
			data-position="center" data-vertical="15%" data-show-delay="2000" data-hide-delay="200" data-show-transition="left" data-hide-transition="down">
			   Yanling Wu(yw996) | Yeh Tawei(ty359)</p>

		</div>
		<!-- Slides End -->

		<!-- Slides -->
		<div class="sp-slide clean-main-slides">
			<div class="clean-img-overlay"></div>

			<img class="sp-image" src="images/slider/car3.jpg" alt="Slider 3"/>

			<h1 class="sp-layer clean-slider-text-big"
			data-position="center" data-show-transition="right" data-hide-transition="right" data-show-delay="1500" data-hide-delay="200">
			 <span class="clean-color-contras">Tracking Robotic Car </span>
			</h1>

			<p class="sp-layer"
			data-position="center" data-vertical="15%" data-show-delay="1000" data-hide-delay="200" data-show-transition="left" data-hide-transition="down">
				Robotic car can track a falling balloon and pop it.
			</p>

		</div>
		<!-- Slides End -->

	</div>
</section>


<!-- ===================================
	OBJECTIVE SECTION
==================================== -->
<section id="objective" class="clean-section-wrapper background-one">
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">

				<h1><span class="clean-color-contras">Objective </span></h1>
				<div class="clean-line"></div>
				<iframe width="560" height="315" src="https://www.youtube.com/embed/_2IYR1ttT54" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">An autonomous balloon tracking vehicle capable of tracking a balloon and terminating it.  </p>
			</div>
			<!-- Section Header End -->

		</div>
	</div>
</section>





<!-- ===================================
	ABOUT SECTION -- Introduction section
==================================== -->
<section id="about" class="clean-section-wrapper background-one">
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
				<h1><span class="clean-color-contras">Introduction </span></h1>
				<div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">Based on Raspberry Pi, we create a tracking robot that can track a falling red balloon and try to pop the balloon before it lands. In order to recognize the balloon, we implemented the color detection by OpenCV. The precise and stable locomotive of the robot, which includes camera tilt kit and two DC motors, has been controlled via PID algorithm. Besides, leveraging python’s multiprocessor modules tremendously decreases image processing latency in real-time. </p>
			</div>
			<!-- Section Header End -->

			<!-- What We Do -->
			<div class="clean-what-we-do">
				<a href="#Pi_camera">

					<div class="col-md-3 col-sm-3 col-xs-12 clean-blurb-round-icon wow bounceInLeft">
						<div class="clean-icon">
							<i class="fa fa-html5"></i>
						</div>
						<h3>Pi Camera</h3>
						<p>Object Recognition</p>
					</div>
				</a>

				<a href="#Tilt_kit">
					<div class="col-md-3 col-sm-3 col-xs-12 clean-blurb-round-icon wow bounceIn" data-wow-delay=".5s">
						<div class="clean-icon">
							<i class="fa fa-css3"></i>
						</div>
						<h3>Tilt kit</h3>
						<p>Haedware PWM</p>
					</div>
				</a>

				<a href="#Multiprocessing">
					<div class="col-md-3 col-sm-3 col-xs-12 clean-blurb-round-icon wow bounceIn" data-wow-delay=".5s">
						<div class="clean-icon">
							<i class="fa fa-laptop"></i>
						</div>
						<h3>Multiprocessing</h3>
						<p>Decrease latency</p>
					</div>
				</a>

				<a href="#Controller">
					<div class="col-md-3 col-sm-3 col-xs-12 clean-blurb-round-icon wow bounceInRight" data-wow-delay=".5s">
						<div class="clean-icon">
							<i class="fa fa-support"></i>
						</div>
						<h3>DC motor controller</h3>
						<p>wheels & PID </p>
					</div>
				</a>

			</div>
			<!-- What We Do End -->

		</div>
	</div>
</section>





<!-- ===================================
	FEATURED WORK SECTION -- Design Section
==================================== -->
<section id="featured-works" class="clean-section-wrapper">
	<!-- Container -->
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
			  <h1><span class="clean-color-contras">Design </span></h1>
			  <div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">Since we only have one Pi camera, we couldn’t measure the distance from the method of two camera. Our solution is to keep the balloon on the center of the image as possible. Therefore, the area would represent as the distance between the balloon and the robot. The Y axis differential would be the rotation error. And the X axis differential would be the tilt error. Consequently, our robot should require the accurate recognition on the balloon.  </p>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">
				To accomplish the project, we have divided it into several smaller tasks and combine them in the end. In general, there are two parts which are hardware and software. And they have different tasks to be tackled in the following introduction.</p>
			</div>
			<!-- Section Header End -->

		</div>
	</div>
	<!-- Container End -->

<!-- ===================================
	SCREENSHOOT --- hardware part
==================================== -->
<section class="clean-custom-sec clean-section-wrapper background-two">
	<div class="container">
		<div class="row">
			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
				<h1><span class="clean-color-contras">Hardware Part</span></h1>
				<div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">`The body of the car. </p>

			</div>
			<!-- Section Header End -->

			<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>Overall</h3>
				<p>Our robot, in short, is a differential drive vehicle with a Pi camera on it. Therefore, we would need two motors to drive the robot and a ball bearing keep it balancing. We also need robot frames to hold everything up. Here’s our shot of the robot. </p>

				<br />
				<br />
				<br />

				<h3>1. Self-designed motor bracket</h3>
				<p>Everything is in placed from the previous lab section, except the motor brackets. We self-designed the motor brackets using Solidworks. After several simulation and testing, we would be able to fit the motor with the robot frame properly. </p>
			</div>

			<div id=Controller class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>2. DC motor driver</h3>

				<p>Due to the speed limit, the Parallax continuous rotation servo is replaced by TT DC Gearbox Motor with higher rpm (200RPM). However, unlike Parallax continuous rotation servo, we can’t control the DC motor with PWM commands. The DC motor is powered from 3VDC to 6VDC. The higher voltage, the faster it goes. As a result, we bought a motor driver – “RasPi Robot Board v3”. It could transform the PWM signal into voltage level and thereby control our DC motors. </p>
				<p>The driver is best required with 9VDC input to supply the motors, although a motor only required 5DV input. This is because if the voltage input is lower than 9VDC, the driver could be malfunctioning. Any unexpected result would come out of nowhere and it’s a painful bug to be realized when developing the robot. </p>

				<p>Also, keep in mind that although 6VDC is its maximum speed limit, it is when the DC motor is unloaded. Moreover, the higher voltage it required, the more current it would need as well. In terms of that means it’s more power consumption than normal, and we need to keep changing the batteries for stable speed outcome and high rpm.</p>
			</div>

<!-- Featured Works Slider -->
	<div class="container-fluid">
		<div class="row-fluid">

			<div class="clean-portfolio-work-slider-section wow fadeIn" data-wow-duration="2s">
				<div id="featured-work-slider" class="owl-carousel clean-portfolio-works-slider">
					<!-- Work 1 -->
					<div class="clean-portfolio-work-item">

						<img src="images/featured-work/1.png" alt="Feature Work 1">
						<div class="clean-port-work-details">
							<ul class="clean-work-meta">
								<li class="clean-lighbox"><a href="images/featured-work/1.png" class="clean-featured-work-img"><i class="fa fa-cog"></i></a></li>
							</ul>
						</div>

					</div>
					<!-- Work 1 End -->

					<!-- Work 2 -->
					<div class="clean-portfolio-work-item">

						<img src="images/featured-work/2.png" alt="Feature Work 2">
						<div class="clean-port-work-details">
							<ul class="clean-work-meta">
								<li class="clean-lighbox"><a href="images/featured-work/2.png" class="clean-featured-work-img"><i class="fa fa-cog"></i></a></li>
							</ul>
						</div>

					</div>
					<!-- Work 2 End -->

					<!-- Work 3 -->
					<div class="clean-portfolio-work-item">

						<img src="images/featured-work/3.png" alt="Feature Work 3">
						<div class="clean-port-work-details">
							<ul class="clean-work-meta">
								<li class="clean-lighbox"><a href="images/featured-work/3.png" class="clean-featured-work-img"><i class="fa fa-cog"></i></a></li>
							</ul>
						</div>

					</div>
					<!-- Work 3 End -->

					<!-- Work 4 -->
					<div class="clean-portfolio-work-item">

						<img src="images/featured-work/4.png" alt="Feature Work 4">
						<div class="clean-port-work-details">
							<ul class="clean-work-meta">
								<li class="clean-lighbox"><a href="images/featured-work/4.png" class="clean-featured-work-img"><i class="fa fa-cog"></i></a></li>
							</ul>
						</div>

					</div>
					<!-- Work 4 End -->
				</div>
			</div>
		</div>
	</div>
			</div>
		</div>
</section>

<!-- ===================================
	SCREENSHOOT --- software part
==================================== -->
<section class="clean-custom-sec clean-section-wrapper background-two">
	<div class="container">
		<div class="row">
			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
				<h1><span class="clean-color-contras">Software Part</span></h1>
				<div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">The organ of the car. </p>
			</div>
			<!-- Section Header End -->

			<div id=Pi_camera class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>1.Object Recognition Algorithm</h3>
				<p>Our object recognition algorithm could detect the red objects videoed by the Pi camera and calculate the center position. The usage of the OpenCV library makes the algorithm easy to implement. First of all, we install the openCV library into our Raspberry Pi. There are some ways to install the openCV library. The easiest and direct method is to run the command “sudo apt-get install libopencv-dev python-opencv” in the command prompt, which can help us to save several hours to compile the openCV. The version of our installed openCV is '2.4.9.1'. After installing the openCV successfully, we need to assemble the Pi camera onto the R-Pi and set it up in configuration of R-Pi. As for the design of the recognition algorithm, it can be broken up into following parts. </p>

				<p>
				<ol><li>
					Create a video capture object of openCV which can take picture at real time by running “cv2.VideoCapture(0)” and when using “cap.read()”, it will return 640*480*3 picture array, which is the default resolution and can fit our requirement of recognition. Three channels is (R, G, B) color space.
					</li>

					<li>
					Run “cv2.cvtColor(frame, cv2.COLOR_RGB2HSV)” can convert the image from RGB color space to HSV (hue, Saturation, Value) color space. We can benefit from this conversion because we need to threshold the HSV image to get the binary image which only keep the red balloon part by setting the low_red and upper_red threshold and it is convenient and easy for us to adjust the threshold in HSV color space.
					</li>

					<li>
					We set the lower_red is (156, 100, 40) and the upper_red is (180, 255, 255). Use the syntax of “maks = cv2.inRange(hsv, low_red, upper_red)” to do threshold. It will make the pixel values that are less than lower_red and more than upper_red equal to zero and the pixel values that are in between them equal to 255.
					</li>

					<li>
					We also use the techniques of computer vision to process the binary images including do “cv2.morphologyEx” of open and close to filter the background noise and make the boundary of binary image smooth and clear.
					</li>

					<li>Run “cv2.findContours(mask,cv2.RETR_EXTERNAL,cv2.CHAIN_APPROX_NONE)” to do the most important thing which is extract the boundary of the object. If it detects the boundary, it will return a list that contains several calculated contours although most of them are zero. If it does not, it will return a empty list.
					</li>

					<li>
					We need to pick up the longest contour from returned contour list. The method we used is to calculate the area of every contour and find the maximum value that is what we want. Then, calculate the spatial moment that can compute the center position of the object and the area of the objects.
					</li>
				</ol>
				</p>

				<br />

				<h3>2.Prediction Algorithm: </h3>
				<p>When balloon quickly moved and get rid of the range that the camera can video, the servo of camera will not know how to move and it will be stuck. To solve this problem, we create the prediction algorithm. Prediction Algorithm is to make the servo move at the speed that is slower than the original speed but the same direction. “Original speed” is the speed of car before the balloon disappears. This is reasonable because the balloon is falling and we assume there is no wind to affect the balloon’s motion. </p>

			<br />

			<h3>3.Pygame interface </h3>
				<p>There are three modes in tracking robotic car. We use pygame library to implement visual interface to control them as the following picture shown. </p>
				<p>
					<li>
					The first mode is calibration mode, which is to find the balloon at the beginning in case the person who toss the balloon standing behind the car and it will not see the balloon.
					</li>

					<li>
					The second mode is play mode, which is main program to realize our function. When a person toss a red balloon, the car will track the balloon until it explodes the balloon.
					</li>

					<li>
					The third mode is celebration mode, which makes the car turn around and move forward and backward like a puppy.
					</li>
				</p>
			<img src="images/slider/pygame_interface.png" alt="pygame interface" height="300" width="400">

			</div>

			<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>4.PID control Algorithm:</h3>

				<p>
				Our objective is to make the balloon as center as possible. From the respective of the image input, the size of the image is 640*480 and thus the center of the image should be (320, 240). The image processing would recognize the red balloon, find out the contour, and calculate the center point and area.
				</p>

				<p>Given the balloon’s coordinates and the area, which is the system output, we would be able to control the robot with a closed loop controller. To make a simple closed loop controller, we choose PID controller. The benefits are one that it is simple, and second it is robust enough for our robot.
				</p>
				<p>PID algorithm is a closed loop control algorithm. PID stands for proportional-integral-derivative. It takes the present error, past error, and the future error as inputs to make appropriate control and thus reduce the error.
				</p>

				<p>
				\(
				K_i = \frac{K_p}{T_i}, K_d = K_p T_d
				\)

				<br/>
				<br/>
				\(
				u(t) = K(e(t) + \frac{1}{T_i} \int_{t}^{0} e(\tau) d\tau + T_d \frac{de(t)}{dt} )
				\)
				</p>

				<li> P-term: proportional to the error. </li>
				<li> I-term : proportional to the integral of the error, </li>
				<li> D-term: proportional to the derivative of the error. </li>
				<p>
				Actually, not all PID controller used up three terms. To be more specific, the there are controllers like
				</p>
				<li> PD controller, which Ti is unbounded. </li>
				<li> PI controller, which Td is zero. </li>
				<li> P controller, which Ti is unbounded and Td is zero. </li>

				<p>
				Ti is the period of the integration time, and Td is the period of the oscillation time. </p>
				<p>
				For the reason that I-term is generally considered as dangerous when implementing PID controller, we only choose P controller and PD controller.  </p>
				<p>
				So how do we actually control our robot with PID controller? We have three degree of freedom, which is the tilt motor for the camera, the forward velocity for the robot, and the rotation of the robot. The robot has a constraint on side ways that it couldn’t move directly to the left or right. Thus, we overcome this problem by rotating the robot with motor rotating in the opposite direction. The forward and backward velocity is depending on the balloon area shown on the image. The rotation of the robot is depending on the X axis differential of from the image center. The camera tile motor is depending on the Y axis differential of from the image center.
				</p>
			</div>

			<div id=Multiprocessing class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>5. Multiprocessing Algorithm:</h3>
				<p>To achieve our goal of tracking a falliing and moving balloon and pop it, we must decrease the latency and running time of every part as far as possible. At the beginning, the recognition and the course of sending order to control the motors and servo took about 105ms, which means it only processed less than ten pictures every second and it is far away from what we should do since we need to track the moving object and we only have limited time to decide the car’s movement. This delay time is too long. To reduce the delay time, one solution is to parallel process different task because of four cores in R-Pi, we can assign four jobs into four cores. In python, we could use the multiprocessing library to fully take advantage of four cores of R-Pi. </p>
				<p><ol>
					<li>The first core is used to focus on capturing the video and put the image it reads into the “send_frame_queue”, whose minimum running time is 33 ms because the frequency of the Pi camera taking video is 30 fps. </li>

					<li>The second core is used to get the frame of images from send_frame_queue and process the images and extract the contours. Then put the contours into receive_contour_queue, which takes about 10 ms at most.
					</li>

					<li>
					The third core could get the contour from receive_contour_queue and compute the center position and area of the object and implement the PID control algorithm and control the motors of wheels. Since we set the sleep time to 20 ms when controlling the DC motors. In addition, it should put the parameters of controlling servo of camera into send_motor_queue. And the maximum running time of this processor is 22 ms.
					</li>

					<li>
					The forth core can get the parameters to control the tilt kit from send_motor_queue and realize prediction function to ensure the smooth movement of tilt kit , whose maximum running time is 25 ms.
					</li>
				</ol>
				</p>

				<p>This describes the tasks that every core executes and the time they spend. The longest time is up to the frequency of the Pi camera, which is unchangeable to some degree. So this multiprocessing system has optimized the entire program and decrease the running time every loop from 105 ms to 34 ms. Note that the “print” syntax will cause the delay and if wanting show the image onto the monitors, it will increase delay time. </p>
			</div>
		</div>
	</div>
</section>


<!-- ===================================
	OFFER SECTION ---Testing and issues
==================================== -->
<section id="offer" class="clean-section-wrapper clean-offer-section  background-two">
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
				<h1><span class="clean-color-contras">Testing and Issues</span></h1>
			</div>
		</div>
	</div>
</section>
		<!-- Section Header End -->

<!-- ===================================
	SCREENSHOOT --- Issue
==================================== -->
<section class="clean-custom-sec clean-section-wrapper background-two">
	<div class="container">
		<div class="row">
				<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>1. C++ OpenCV install</h3>
				<p>
				Since our robotic car need to track the falling balloon and move to the landing location very fast and considering that python is a kind of interpreted programming language and C++ is a complied programming language, we initially planned to install C++ version of openCV. We tried to install the C++ OpenCV library several times and every time it took more than three hours to compile it. We finally installed the C++ openCV successfully but when we tried to run some codes, it failed and said that it cannot open the Pi camera, which took us about one week. After discussion with Professor Skovira, we decide to use python openCV first and see whether it can meet our requirement. But we will still introduce how to install C++ openCV here briefly.
				<ol>
					<li>
						First of all, we need to install several required packages that we have not installed before such as CMake 2,8,7 or higher, Git, GCC and GTK+2.x or higher, including headers (libgtk2.0-dev). These packages can be installed in a terminal directly.
					</li>

					<li>
					Secondly, OpenCV Source Code is needed which can download from the Git Repository by the command “cd ~/[my_working_directory] git clone https://github.com/opencv/opencv.git git clone https://github.com/opencv/opencv_contrib.git”
					</li>

					<li>
					Thirdly, Building OpenCV from Source using CMake.
						<ol>
							<li>
							Create a temporary directory, where we want to put the generated Makefiles, project files as well as output file and enter there.
							</li>

							<li>
							Configure it by running “cmake -D CMAKE_BUILD_TYPE=Release -D CMAKE_INSTALL_PREFIX=/usr/local ..”, which will take more than ten minutes.
							</li>

							<li>
							After finishing this, we need to describe some parameters or during the process of compiling, there will be some errors.
							</li>

							<li>
							From build directory execute “make -j7 # runs 7 jobs in parallel”.
							</li>

							<li>
							Install the library by execute “sudo make install” form build directory.
							</li>
						</ol>
					</li>
					</ol>
					</p>
				<p>
					It should work, but there will definitely be a lot of errors. Good Luck!
				</p>
			</div>

			<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>2.Pi Camera Setting</h3>
				<p>After python OpenCV library installed, we tried to run testing code, there is one error saying “OpenCV Error: Assertion failed (scn == 3 || scn == 4) in cvtColor, file /build/opencv-U1UwfN/opencv-2.4.9.1+dfsq1/modules/imgproc/src/color.cpp, line 3737”. We searched it on Google, this error can be fixed by running “sudo modprobe bcm2835-v4l2“, which is used to intall the v412 driver on the bcm2835. We thought it is one time install but when the R-Pi reboot, the same error appeared again. Therefore, we add this command into /etc/modules. Then, it can work smoothly.</p>
			</div>

			<div id=Tilt_kit class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>3. Hardware PWM</h3>
				<p>To control the servo of pan tilt kit, under the recommendation of Professor Skovira, we use the hardware PWM to generate control signal instead of software PWM, this is because the signal generated by hardware PWM is stable and less noise in a R-Pi multiprocessing environment. When we following the instruction of the professor to build the hardware PWM file and connect the circuit, we cannot send any signal to the GPIO pin. After asking other students who have experience to implement the hardware PWM, we know some very significant points. One is only GPIO pin 12 and pin 13 can be used to generated hardware PWM signal. Another is before running the code, we need to run “sudo pigpiod” to launch the pigpio library as a daemon. </p>
			</div>

			<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<h3>4. DC controller</h3>
				<p>Because of tracking and chasing the falling balloon, we need to faster motors to drive the robotic car and thus, with the help of the professor Skovira, we decide to use the DC motor to drive and buy DC controller to control two DC motor to move. It works well but we found that once we add the controller program into multiprocessing, the whole program will be stuck and the queue will keep a lot of unprocessed data. After we monitored the running time of every core, we noticed that the every running time of the third core which is used to process the PID control algorithm and send order to DC controller is far longer than others and the average running time is 202 ms. At first, we thought this could be the problem of the hardware because of the delay of opening motors or the bad connection of circuit to make the transmitting slow. But when we check everything about the circuit, there is no bad connection. So we searched the software stuff. We found there is a syntax about “time.sleep(0.2)” in the library that is used to control the DC controller and this is probably the reason why it runs so slowly. So we changed the source of the library and compile it again. It worked, the running time of the third core decreased to 22 ms. </p>
			</div>
		</div>
	</div>
</section>


<!-- ===================================
	Result and Conclusion SECTION
==================================== -->
<section id="pricing" class="clean-pricing-section">
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
			  <h1><font color="#7cd552">Result</font></h1>
			  <div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">Initially, we were very concerned about that torque and speed of our motor. Since tossing a ball and catch it before it lands is a hard job to achieve, the robot would require a high speed motor and high speed object detection. To achieve this goal, we were thinking about designing a new gear box with lower reduction ratio. By lowering the reduction ration, the motor would have higher speed but lower torque. It is possible that the new designed gear box wouldn’t work out and ended up consuming us a lot of time. Also, both of us had few knowledges about designing a 3d object, not to mention designing a gear box. As a result, we decided to stay with the original reduction ratio and take the easier task to design the motors’ bracket. </p>
				<br/>
				<br/>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">
				Overall, we approximately meet the goals outlined in the description. Still, there are several changes that allow us to finish the project in a short time. First, rather than installing two cameras for object distance detection, we represent the distance from the object area in an image. Second, rather than catching the balloon into a bucket, we use needles to pop the balloon which would dramatically show the catching result. </p>
			</div>
			<!-- Section Header End -->

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
			  <h1><font color="#7cd552">Conclusion</font></h1>
			  <div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">Our robot achieved the objective to terminate the balloon before it lands. Also, we realized that if it wasn’t balloon, the ball would only spend two seconds before it lands. On the other hand, if the ball is changed to a balloon, the air resistance would slow down the dropping balloon. </p>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">
				Nevertheless, if the robot is equipped with two cameras, it would take more computing time and would eventually slow down the tracking efficiency. Take our project as an example, our tracking function need 10 milliseconds to compute the object contour and 2 milliseconds to compute the control output. The new input image is renewed with every 30 milliseconds (30fps). If it were two cameras input the images, the contour calculating function would be doubled up. Thus, the output time from fetching an image and output a control signal could take more than 25 milliseconds in idea way. Moreover, we weren’t using higher priority from CPU, there would definitely be more latency when executing the program. </p>
			</div>
			<!-- Section Header End -->
		</div>
	</div>
</section>

<!-- ===================================
	Future Work SECTION
==================================== -->
<section id="testimonial" class="clean-pricing-section">
	<div class="container">
		<div class="row">

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
			  <h1><font color="#7cd552">Future Work</font></h1>
			  <div class="clean-line"></div>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">We would spend more time on developing the algorithm for estimating an object’s trajectory. Because there were times that the robot couldn’t track the balloon if it suddenly moved away, we would need a trajectory prediction algorithm to overcome this issue. </p>
				<br/>
				<br/>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">
				Also, during tracking mode the robot wasn’t performing its rotation obviously. We would refine the speed controller for faster response when it is moving forward and rotating. </p>
			</div>
			<!-- Section Header End -->

			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">

			  <h1><font color="#7cd552">Team</font></h1>
				<img src="images/slider/us2.png" alt="Team Picture" width="700px">
				
			</div>
			<!-- Section Header End -->
			<div class="col-md-6 col-sm-6 col-xs-12 clean-custom-sec-text wow bounceInRight">
				<img src="images/slider/Ta-Wei-Yeh.png" alt="Team Picture" height="200" width="200">
			</div>
			

		</div>
	</div>
</section>



<!-- ===================================
	Appendix SECTION
==================================== -->
<section id="contact" class="clean-section-wrapper clean-contact-section background-one" data-stellar-background-ratio="0.5">
<div class="clean-parallax-overlay"></div>
	<div class="container">
		<div class="row">


			<!-- Section Header -->
			<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
				<h1><span class="clean-color-contras">Appendix</span></h1>
				<h2><span class="clean-color-contras"><em>1. Budget</em></span></h2>
			  <center>
				<p class="col-md-8 col-sm-10 col-xs-12 col-md-offset-2 col-sm-offset-1">

					<table>
					  <thead>
						<tr>
						  <th>Item</th>
						  <th>Unit Cost  </th>
						  <th>Quantity</th>
						  <th>Total Cost</th>
						</tr>
					  </thead>
					  <tbody>
						<tr>
						  <td>Raspberry Pi Camera </td>
						  <td>$29.95</td>
						  <td>1</td>
						  <td>$29.95</td>
						</tr>
						<tr>
						  <td>DC Motors(From Prof. Skovira) </td>
						  <td>$2.95</td>
						  <td>2</td>
						  <td>$5.9</td>
						</tr>
						<tr>
						  <td>Tilt Kit and Servos</td>
						  <td>$8.89</td>
						  <td>1</td>
						  <td>$8.89</td>
						</tr>
						<tr>
						  <td>DC Motor Controller</td>
						  <td>$29.95</td>
						  <td>1</td>
						  <td>$29.95</td>
						</tr>
						<tr>
						  <td>Balloon </td>
						  <td>$2.94</td>
						  <td>1</td>
						  <td>$2.94</td>
						</tr>
						<tr>
						  <td>Safe Pin</td>
						  <td>$1.98</td>
						  <td>1</td>
						  <td>$1.98</td>
						</tr>
						<tr>
						  <td>3D Printer</td>
						  <td>Free</td>
						  <td>n</td>
						  <td>Free</td>
						</tr>
						<tr>
						  <td> Total </td>
						  <td> </td>
						  <td> </td>
						  <td>$79.61</td>
						</tr>
					  </tbody>
					</table>

				</p>
				</center>

			</div>
			<!-- Section Header End -->
		</div>
	</div>

</section>

<div id="preview">
	<div class="col-md-12 col-sm-12 col-xs-12 clean-section-header wow fadeInDown">
		<h2><span class="clean-color-contras"><em>2. Code</em></span></h2>
	</div>
	<!-- HTML generated using hilite.me --><div style="background: #ffffff; overflow:auto;width:auto;border:solid gray;border-width:.1em .1em .1em .8em;padding:.2em .6em;"><table><tr><td><pre style="margin: 0; line-height: 125%">  1
	  2
	  3
	  4
	  5
	  6
	  7
	  8
	  9
	 10
	 11
	 12
	 13
	 14
	 15
	 16
	 17
	 18
	 19
	 20
	 21
	 22
	 23
	 24
	 25
	 26
	 27
	 28
	 29
	 30
	 31
	 32
	 33
	 34
	 35
	 36
	 37
	 38
	 39
	 40
	 41
	 42
	 43
	 44
	 45
	 46
	 47
	 48
	 49
	 50
	 51
	 52
	 53
	 54
	 55
	 56
	 57
	 58
	 59
	 60
	 61
	 62
	 63
	 64
	 65
	 66
	 67
	 68
	 69
	 70
	 71
	 72
	 73
	 74
	 75
	 76
	 77
	 78
	 79
	 80
	 81
	 82
	 83
	 84
	 85
	 86
	 87
	 88
	 89
	 90
	 91
	 92
	 93
	 94
	 95
	 96
	 97
	 98
	 99
	100
	101
	102
	103
	104
	105
	106
	107
	108
	109
	110
	111
	112
	113
	114
	115
	116
	117
	118
	119
	120
	121
	122
	123
	124
	125
	126
	127
	128
	129
	130
	131
	132
	133
	134
	135
	136
	137
	138
	139
	140
	141
	142
	143
	144
	145
	146
	147
	148
	149
	150
	151
	152
	153
	154
	155
	156
	157
	158
	159
	160
	161
	162
	163
	164
	165
	166
	167
	168
	169
	170
	171
	172
	173
	174
	175
	176
	177
	178
	179
	180
	181
	182
	183
	184
	185
	186
	187
	188
	189
	190
	191
	192
	193
	194
	195
	196
	197
	198
	199
	200
	201
	202
	203
	204
	205
	206
	207
	208
	209
	210
	211
	212
	213
	214
	215
	216
	217
	218
	219
	220
	221
	222
	223
	224
	225
	226
	227
	228
	229
	230
	231
	232
	233
	234
	235
	236
	237
	238
	239
	240
	241
	242
	243
	244
	245
	246
	247
	248
	249
	250
	251
	252
	253
	254
	255
	256
	257
	258
	259
	260
	261
	262
	263
	264
	265
	266
	267
	268
	269
	270
	271
	272
	273
	274
	275
	276
	277
	278
	279
	280
	281
	282
	283
	284
	285
	286
	287
	288
	289
	290
	291
	292
	293
	294
	295
	296
	297
	298
	299
	300
	301
	302
	303
	304
	305
	306
	307
	308
	309
	310
	311
	312
	313
	314
	315
	316
	317
	318
	319
	320
	321
	322
	323
	324
	325
	326
	327
	328
	329
	330
	331
	332
	333
	334
	335
	336
	337
	338
	339
	340
	341
	342
	343
	344
	345
	346
	347
	348
	349
	350
	351
	352
	353
	354
	355
	356
	357
	358
	359
	360
	361
	362
	363
	364
	365
	366
	367
	368
	369
	370
	371
	372
	373
	374
	375
	376
	377
	378
	379
	380
	381
	382
	383
	384
	385
	386
	387
	388
	389
	390
	391
	392
	393
	394
	395
	396
	397
	398
	399
	400
	401
	402
	403
	404
	405
	406
	407
	408
	409
	410
	411
	412
	413
	414
	415
	416
	417
	418
	419
	420
	421
	422
	423
	424
	425
	426
	427
	428
	429
	430</pre></td><td><pre style="margin: 0; line-height: 125%"><span style="color: #888888">#########################################################</span>
	<span style="color: #888888">### Yanling Wu (yw996), Yeh Dawei(ty359) 	       ##</span>
	<span style="color: #888888">### This is the main code for tracking the red balloon ##</span>
	<span style="color: #888888">### and try to pop the balloon 		       ##</span>
	<span style="color: #888888">#########################################################</span>


	<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">multiprocessing</span> <span style="color: #008800; font-weight: bold">import</span> Process, Queue, Value, Lock, Array
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">time</span>
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">numpy</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">np</span>
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">cv2</span>
	<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">datetime</span> <span style="color: #008800; font-weight: bold">import</span> datetime
	<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">motor_controller</span> <span style="color: #008800; font-weight: bold">import</span> motor_controller
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">RPi.GPIO</span> <span style="color: #008800; font-weight: bold">as</span> <span style="color: #0e84b5; font-weight: bold">GPIO</span>
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">sys</span>
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">subprocess</span>
	<span style="color: #008800; font-weight: bold">import</span> <span style="color: #0e84b5; font-weight: bold">pigpio</span>

	<span style="color: #008800; font-weight: bold">from</span> <span style="color: #0e84b5; font-weight: bold">motor_controller</span> <span style="color: #008800; font-weight: bold">import</span> motor_controller

	<span style="color: #888888">#set fro broadcom numbering not board numbers</span>
	GPIO<span style="color: #333333">.</span>setmode(GPIO<span style="color: #333333">.</span>BCM)
	<span style="color: #888888"># Set Up Pan Tilt Servo HardwarePWM Pins</span>
	motorPinT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">12</span>
	<span style="color: #888888"># connect to pi gpio Daemon</span>
	pi_hw <span style="color: #333333">=</span> pigpio<span style="color: #333333">.</span>pi()
	<span style="color: #888888">#set the original position of tilt of camera</span>
	currentDutyCycleT <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">115000</span> <span style="color: #888888"># look at forward 	</span>

	<span style="color: #888888">#Rotate the camera to make the balloon in the center of the image</span>
	<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">rotate_camera</span>(<span style="color: #007020">dir</span>, strength):
		<span style="color: #008800; font-weight: bold">global</span> currentDutyCycleT
		full_up <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">65000</span> <span style="color: #888888"># 1.3ms -&gt; up</span>
		full_down <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">115000</span> <span style="color: #888888"># 2.3ms -&gt; forward</span>
		<span style="color: #888888">#increment is 200 everytime</span>
		increment <span style="color: #333333">=</span> (full_down <span style="color: #333333">-</span> full_up) <span style="color: #333333">/</span> <span style="color: #0000DD; font-weight: bold">200</span>
		<span style="color: #888888">#camera up</span>
		<span style="color: #008800; font-weight: bold">if</span> <span style="color: #007020">dir</span> <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>:
			currentDutyCycleT <span style="color: #333333">=</span> currentDutyCycleT <span style="color: #333333">-</span> strength <span style="color: #333333">*</span> increment
			<span style="color: #008800; font-weight: bold">if</span> currentDutyCycleT <span style="color: #333333">&lt;</span> full_up:
				currentDutyCycleT <span style="color: #333333">=</span> full_up

		<span style="color: #008800; font-weight: bold">elif</span> <span style="color: #007020">dir</span> <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:
			pi_hw<span style="color: #333333">.</span>hardware_PWM(motorPinR, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">0</span>) <span style="color: #888888">#50 Hz Freq. 0% duty cycle</span>
			pi_hw<span style="color: #333333">.</span>hardware_PWM(motorPinT, <span style="color: #0000DD; font-weight: bold">50</span>, <span style="color: #0000DD; font-weight: bold">0</span>) <span style="color: #888888">#50 Hz Freq. 0% duty cycle</span>
			currentDutyCycleT <span style="color: #333333">=</span> currentDutyCycleT <span style="color: #333333">-</span> strength <span style="color: #333333">*</span> increment
			<span style="color: #008800; font-weight: bold">if</span> currentDutyCycleT <span style="color: #333333">&lt;</span> full_up:
				currentDutyCycleT <span style="color: #333333">=</span> full_down
		<span style="color: #888888">#camera down</span>
		<span style="color: #008800; font-weight: bold">else</span>:
			currentDutyCycleT <span style="color: #333333">=</span> currentDutyCycleT <span style="color: #333333">+</span> strength <span style="color: #333333">*</span> increment <span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">2</span>
			<span style="color: #008800; font-weight: bold">if</span> currentDutyCycleT <span style="color: #333333">&gt;</span> full_down:
				currentDutyCycleT <span style="color: #333333">=</span> full_down
		pi_hw<span style="color: #333333">.</span>hardware_PWM(motorPinT, <span style="color: #0000DD; font-weight: bold">50</span>, currentDutyCycleT) <span style="color: #888888">#50 Hz Freq.</span>
		<span style="color: #888888">##print(&quot;rotate_camera Function :  change the camera\n&quot;)</span>


	tilt_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time() <span style="color: #888888"># record the length of giving order to tilt</span>
	<span style="color: #888888">#Master Process --- recognize the red balloon</span>
	<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">recognize_balloon</span>(send_frame_queue, p_start_turn, p_end_turn, p_start_lock, p_end_lock):
		last_contour_receive_time <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		start_queue <span style="color: #333333">=</span> datetime<span style="color: #333333">.</span>now()
		count_put <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		<span style="color: #008800; font-weight: bold">global</span> count1
		<span style="color: #008800; font-weight: bold">global</span> count2
		<span style="color: #008800; font-weight: bold">global</span> count3
		<span style="color: #008800; font-weight: bold">global</span> run_flag
		time_total_run <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
		waiting_threshold <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">10</span>
		calibration <span style="color: #333333">=</span> <span style="color: #007020">False</span>
		<span style="color: #888888">#print(run_flag.value)</span>

		<span style="color: #008800; font-weight: bold">while</span>(run_flag<span style="color: #333333">.</span>value):
			<span style="color: #008800; font-weight: bold">try</span>:
				run_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
				<span style="color: #888888">#1. get a frame and show ret, </span>
				_, frame <span style="color: #333333">=</span> cap<span style="color: #333333">.</span>read()
				<span style="color: #888888"># height 480; width 640; channel 3</span>
				<span style="color: #888888">#cv2.imshow(&#39;Capture&#39;, frame)</span>
				<span style="color: #888888">#2. change to hsv model </span>
				hsv <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>cvtColor(frame, cv2<span style="color: #333333">.</span>COLOR_BGR2HSV)
				<span style="color: #888888">#3. Threshold the HSV image to get only red colors and get mask </span>
				mask <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>inRange(hsv, lower_red, upper_red) <span style="color: #888888">#lower than </span>
				<span style="color: #888888"># #print(mask)</span>
				<span style="color: #888888"># cv2.imshow(&#39;Mask_first&#39;, mask)</span>
				<span style="color: #888888">#print(&#39;count1  %d, count2   %d, count3   %d&#39;%(count1, count2, count3))</span>

				cur_time <span style="color: #333333">=</span> datetime<span style="color: #333333">.</span>now()
				delta_time <span style="color: #333333">=</span> cur_time <span style="color: #333333">-</span> start_queue
				delta_time_tol_ms <span style="color: #333333">=</span> delta_time<span style="color: #333333">.</span>total_seconds()<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">1000</span>

				<span style="color: #008800; font-weight: bold">if</span> (calibration):
					<span style="color: #888888">#print(&quot;Calibration the camera&quot;)</span>
					<span style="color: #008800; font-weight: bold">pass</span>

				<span style="color: #008800; font-weight: bold">else</span>:
					<span style="color: #888888">#only put the mask in queue if it has past 10ms and there are less than 4 masks in queue</span>
					<span style="color: #008800; font-weight: bold">if</span> (delta_time_tol_ms <span style="color: #333333">&gt;</span> waiting_threshold) <span style="color: #000000; font-weight: bold">and</span> (send_frame_queue<span style="color: #333333">.</span>qsize() <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">2</span>) :
						start_queue <span style="color: #333333">=</span> cur_time <span style="color: #888888"># Update last send to queue time</span>
						send_frame_queue<span style="color: #333333">.</span>put(mask)  <span style="color: #888888"># put mask in queue</span>
						<span style="color: #888888"># print(&quot;send_frame_queue&quot;, send_frame_queue.qsize())</span>
						count_put <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
						<span style="color: #888888">#print(&quot;put the mask to queue\n&quot;)</span>
					<span style="color: #888888"># draw the contour of the balloon in the opencv interface but we comment it when runing to decrease the latency</span>
				<span style="color: #888888">#if ((time.time()-last_contour_receive_time) &lt; waiting_threshold/1000.):</span>
					<span style="color: #888888">#cv2.circle(frame, (cx, cy), 7, (255, 255, 255), -1) #Draw center of object</span>
					<span style="color: #888888">#cv2.drawContours(frame,contours,-1,(255,0,0),3) #Draw contour of object</span>

				<span style="color: #888888">#cv2.circle(frame, (center_x, center_y), 2, (0, 0, 255), -1) #Draw center of camera</span>
				<span style="color: #888888">#cv2.imshow(&#39;frame&#39;,frame) #Display Frame</span>

				<span style="color: #888888"># print(&quot;processor 0  time\n\n\n\n &quot;, time.time() - run_time)</span>

				<span style="color: #008800; font-weight: bold">if</span> cv2<span style="color: #333333">.</span>waitKey(<span style="color: #0000DD; font-weight: bold">1</span>) <span style="color: #333333">&amp;</span> <span style="color: #005588; font-weight: bold">0xFF</span> <span style="color: #333333">==</span> <span style="color: #007020">ord</span>(<span style="background-color: #fff0f0">&#39;q&#39;</span>):
					run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
					time_total_run <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> time_total_run
					<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;count_put </span><span style="background-color: #eeeeee">%d</span><span style="background-color: #fff0f0">&#39;</span> <span style="color: #333333">%</span> count_put)
					<span style="color: #888888">#print(&#39;count_#print_x %d&#39; % count_#print_x)</span>
					<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;Total running time&#39;</span> , time_total_run)
					<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Time to process&quot;</span>, time_total_run<span style="color: #333333">/</span>count_put)
			<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
				run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
				time_total_run <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> time_total_run
				<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;count_put </span><span style="background-color: #eeeeee">%d</span><span style="background-color: #fff0f0">&#39;</span> <span style="color: #333333">%</span> count_put)
				<span style="color: #888888">#print(&#39;count_#print_x %d&#39; % count_#print_x)</span>
				<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&#39;Total running time&#39;</span> , time_total_run)
				<span style="color: #008800; font-weight: bold">print</span>(<span style="background-color: #fff0f0">&quot;Time to process&quot;</span>, time_total_run<span style="color: #333333">/</span>count_put)

		<span style="color: #888888">#print(&quot;Quit Processor 0&quot;)</span>

	<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">process_contour_1</span>(send_frame_queue, receive_contour_queue, p_start_turn, p_end_turn, p_start_lock, p_end_lock):
		<span style="color: #008800; font-weight: bold">global</span> count1
		<span style="color: #008800; font-weight: bold">global</span> run_flag
		<span style="color: #008800; font-weight: bold">while</span> (run_flag<span style="color: #333333">.</span>value):
			<span style="color: #008800; font-weight: bold">try</span>:
				run_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
				<span style="color: #888888"># startTime = datetime.now()</span>
				<span style="color: #888888"># startTime_ms = startTime.second *1000 + startTime.microsecond/1000</span>
				<span style="color: #888888"># If frame queue not empty and it is Worker Process 1&#39;s turn</span>
				<span style="color: #008800; font-weight: bold">if</span> ((<span style="color: #000000; font-weight: bold">not</span> send_frame_queue<span style="color: #333333">.</span>empty()) <span style="color: #000000; font-weight: bold">and</span> (p_start_turn<span style="color: #333333">.</span>value <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>)):
					<span style="color: #888888"># print(&quot;1 send_frame_queue  &quot;, send_frame_queue.qsize())</span>
					mask <span style="color: #333333">=</span> send_frame_queue<span style="color: #333333">.</span>get() <span style="color: #888888"># Grab a frame</span>
					<span style="color: #888888">#count1 = 1 + count1</span>
					<span style="color: #888888">#print(&quot;count1   %d&quot; % count1)</span>
					p_start_turn<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span> <span style="color: #888888"># and change it to worker process 2&#39;s turn</span>
					<span style="color: #888888">#print(&quot;Processor 1&#39;s Turn - Receive Mask Successfully&quot;)</span>
					<span style="color: #888888">##print(mask.shape)</span>
					 <span style="color: #888888"># 1. Implement the open and close operation to get rid of noise and solidify an object</span>
					<span style="color: #888888"># maskOpen=cv2.morphologyEx(mask,cv2.MORPH_OPEN,kernelOpen)</span>
					<span style="color: #888888"># maskClose=cv2.morphologyEx(maskOpen,cv2.MORPH_CLOSE,kernelClose)</span>
					<span style="color: #888888"># # 2. Extract contour</span>
					<span style="color: #888888"># contours,h=cv2.findContours(maskClose.copy(),cv2.RETR_EXTERNAL,cv2.CHAIN_APPROX_NONE)</span>

					<span style="color: #888888">#find contours</span>
					contours,h<span style="color: #333333">=</span>cv2<span style="color: #333333">.</span>findContours(mask,cv2<span style="color: #333333">.</span>RETR_EXTERNAL,cv2<span style="color: #333333">.</span>CHAIN_APPROX_NONE)
					receive_contour_queue<span style="color: #333333">.</span>put(contours) <span style="color: #888888"># Put contour back </span>
					<span style="color: #888888">#print(&quot;processor_1 : put contour successfully\n&quot;)</span>
					<span style="color: #888888"># print(&quot;1 receive_contour_queue  &quot;, receive_contour_queue.qsize())</span>

				<span style="color: #008800; font-weight: bold">else</span>:
					<span style="color: #888888">##print(&quot;Processor 1 Didn&#39;t Receive Frame, sleep for 10ms&quot;)</span>
					time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
				currentTime <span style="color: #333333">=</span> datetime<span style="color: #333333">.</span>now()
				currentTime_ms <span style="color: #333333">=</span> currentTime<span style="color: #333333">.</span>second <span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">1000</span> <span style="color: #333333">+</span> currentTime<span style="color: #333333">.</span>microsecond<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">1000</span>
				<span style="color: #888888"># print(&quot;processor 1 time \n\n\n\n &quot;, time.time() - run_time)</span>
				<span style="color: #888888">##print (&quot;Processor 1 Processing Time: &quot; + str(currentTime_ms-startTime_ms))</span>
			<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
				run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

		<span style="color: #888888">#print(&quot;Quiting Processor 1&quot;)</span>

	<span style="color: #888888"># Function for the Worker Process 2</span>
	<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">calculate_contour_2</span>(receive_contour_queue, send_motor_queue, p_start_lock, p_end_lock):
		<span style="color: #008800; font-weight: bold">global</span> count2
		<span style="color: #008800; font-weight: bold">global</span> tilt_time
		<span style="color: #008800; font-weight: bold">global</span> currentDutyCycleT
		<span style="color: #008800; font-weight: bold">global</span> run_flag
		<span style="color: #888888"># global p0,p1,p2,p3</span>
		x_diff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		y_diff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		area_diff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		last_areaDiff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		area <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		last_xdiff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		last_ydiff <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		start_time <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		waiting_threshold <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">20</span>
		count_no_contour <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		<span style="color: #888888">#print(&quot;I am here1&quot;)</span>
		tilt_lst <span style="color: #333333">=</span> [<span style="color: #0000DD; font-weight: bold">0</span>,<span style="color: #0000DD; font-weight: bold">0</span>]
		count <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
		Period <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">200</span>
		controller <span style="color: #333333">=</span> motor_controller()
		<span style="color: #008800; font-weight: bold">while</span> (run_flag<span style="color: #333333">.</span>value):
			<span style="color: #008800; font-weight: bold">try</span>:
				<span style="color: #008800; font-weight: bold">if</span> ((<span style="color: #000000; font-weight: bold">not</span> receive_contour_queue<span style="color: #333333">.</span>empty())):
					<span style="color: #888888">#last_contour_receive_time = time.time()</span>
					contours <span style="color: #333333">=</span> receive_contour_queue<span style="color: #333333">.</span>get() <span style="color: #888888"># Extract contour</span>
					<span style="color: #888888"># print(&quot;Main Processor 2: Get the processed contour from queue\n&quot;)</span>
					<span style="color: #888888"># print(&quot;2 receive_contour_queue  &quot;, receive_contour_queue.qsize())</span>
					count2 <span style="color: #333333">+=</span><span style="color: #0000DD; font-weight: bold">1</span>
					<span style="color: #888888">#print(&quot;count2 &quot;, count2)</span>
					Area_list <span style="color: #333333">=</span> []
					<span style="color: #008800; font-weight: bold">if</span> <span style="color: #0000DD; font-weight: bold">0</span> <span style="color: #333333">==</span> <span style="color: #007020">len</span>(contours):
						<span style="color: #888888"># print(&quot;Calibration --- finding balloon\n\n\n\n\n&quot;)</span>
						<span style="color: #888888"># controller.set_control( 0, 0)</span>
						controller<span style="color: #333333">.</span>set_control( <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">10</span>)
						<span style="color: #008800; font-weight: bold">if</span> count <span style="color: #333333">&lt;</span> Period<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span>:
							tilt_lst[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
							tilt_lst[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.0</span>
						<span style="color: #008800; font-weight: bold">if</span> count <span style="color: #333333">&gt;=</span> Period<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #000000; font-weight: bold">and</span> count <span style="color: #333333">&lt;</span> Period:
							tilt_lst[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>
							tilt_lst[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.0</span>
						<span style="color: #008800; font-weight: bold">if</span> count <span style="color: #333333">==</span> Period:
							count <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
						count <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
						time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
						<span style="color: #888888"># print currentDutyCycleT</span>
						<span style="color: #008800; font-weight: bold">if</span> (send_motor_queue<span style="color: #333333">.</span>qsize() <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">2</span>) :
							send_motor_queue<span style="color: #333333">.</span>put(tilt_lst)
						<span style="color: #008800; font-weight: bold">if</span> count_no_contour <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">150</span>:
							run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
							controller<span style="color: #333333">.</span>clean()
							<span style="color: #008800; font-weight: bold">if</span> run_flag<span style="color: #333333">.</span>value <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>:
								p0<span style="color: #333333">.</span>terminate()
								p1<span style="color: #333333">.</span>terminate()
								p2<span style="color: #333333">.</span>terminate()
								p3<span style="color: #333333">.</span>terminate()
							<span style="color: #888888"># yeh_David</span>
						time<span style="color: #333333">.</span>sleep(waiting_threshold<span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">1000.</span>)
						count_no_contour <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
					<span style="color: #008800; font-weight: bold">else</span>:
						count_no_contour <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
						run_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
						Area_list <span style="color: #333333">=</span> [ cv2<span style="color: #333333">.</span>contourArea(c) <span style="color: #008800; font-weight: bold">for</span> c <span style="color: #000000; font-weight: bold">in</span> contours ]
						<span style="color: #888888">##print (Area_list)</span>
						maxindex <span style="color: #333333">=</span> Area_list<span style="color: #333333">.</span>index(<span style="color: #007020">max</span>(Area_list))
						<span style="color: #888888">##print maxindex</span>
						cnt <span style="color: #333333">=</span> contours[maxindex]<span style="color: #888888">#Get the first contour </span>
						<span style="color: #888888">##print (contours[0])</span>
						M <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>moments(cnt)<span style="color: #888888">#Calculat M of the first contour</span>
						<span style="color: #888888"># #print (M)</span>
						<span style="color: #888888">#calcualte the center coordinate</span>
						<span style="color: #008800; font-weight: bold">if</span> M[<span style="background-color: #fff0f0">&#39;m00&#39;</span>] <span style="color: #333333">!=</span> <span style="color: #0000DD; font-weight: bold">0</span>:
							cx <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&#39;m10&#39;</span>]<span style="color: #333333">/</span>M[<span style="background-color: #fff0f0">&#39;m00&#39;</span>])
							cy <span style="color: #333333">=</span> <span style="color: #007020">int</span>(M[<span style="background-color: #fff0f0">&#39;m01&#39;</span>]<span style="color: #333333">/</span>M[<span style="background-color: #fff0f0">&#39;m00&#39;</span>])
							area <span style="color: #333333">=</span> M[<span style="background-color: #fff0f0">&#39;m00&#39;</span>]
							<span style="color: #888888">#PID control Algo to calculate strength to control servo</span>
							x_diff <span style="color: #333333">=</span> cx <span style="color: #333333">-</span> center_x
							y_diff <span style="color: #333333">=</span> <span style="color: #007020">abs</span>(cy <span style="color: #333333">-</span> center_y)
							area_diff <span style="color: #333333">=</span> area_ref <span style="color: #333333">-</span> area
							<span style="color: #888888"># #print(&quot;x_bar=%f, y_bar= %f&quot; % (cx,cy))</span>
							<span style="color: #888888"># #print(&quot;x_diff= %f, y_diff= %f&quot; % (x_diff,y_diff))</span>
							<span style="color: #888888"># #print(&quot;area = %f&quot; % area)</span>

							<span style="color: #888888">#### PID Parameters ####</span>
							kp_x <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">1.0</span>
							kd_x <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.001</span>
							<span style="color: #888888">### ZH PID</span>
							<span style="color: #888888"># Ku = 3</span>
							<span style="color: #888888"># kp_x = Ku*0.6</span>
							<span style="color: #888888"># Tu = 3</span>
							<span style="color: #888888"># Td = Tu/8</span>
							<span style="color: #888888"># kd_x = kp_x*Td</span>

							kp_z <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">6</span>
							kd_z <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

							kp_y <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">6</span>
							kd_y <span style="color: #333333">=</span> <span style="color: #6600EE; font-weight: bold">0.001</span>

							proportional_x <span style="color: #333333">=</span> x_diff
							proportional_y <span style="color: #333333">=</span> y_diff<span style="color: #333333">/</span>(y_res<span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">2.0</span>)
							proportional_z <span style="color: #333333">=</span> area_diff

							derivative_x <span style="color: #333333">=</span> (last_xdiff <span style="color: #333333">-</span> x_diff)<span style="color: #333333">/</span>(time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> start_time)
							derivative_y <span style="color: #333333">=</span> (last_ydiff <span style="color: #333333">-</span> y_diff)<span style="color: #333333">/</span>(time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> start_time)
							derivative_z <span style="color: #333333">=</span> (last_areaDiff <span style="color: #333333">-</span> area_diff)<span style="color: #333333">/</span>(time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> start_time)

							start_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
							<span style="color: #888888">##print(&quot;derivative_x: &quot; + str(derivative_x))</span>
							<span style="color: #888888">##print(&quot;derivative_x*kd_x: &quot; + str(derivative_x*kd_x))</span>
							<span style="color: #888888">#start_time = time.time()</span>
							strength_x <span style="color: #333333">=</span> proportional_x<span style="color: #333333">*</span>kp_x <span style="color: #333333">+</span> derivative_x<span style="color: #333333">*</span>kd_x
							strength_z <span style="color: #333333">=</span> proportional_z<span style="color: #333333">*</span>kp_z <span style="color: #333333">+</span> derivative_z<span style="color: #333333">*</span>kd_z
							strength_y <span style="color: #333333">=</span> proportional_y<span style="color: #333333">*</span>kp_y <span style="color: #333333">-</span> derivative_y<span style="color: #333333">*</span>kd_y
							<span style="color: #888888">##print &quot;strength:&quot;</span>
							<span style="color: #888888">##print strength_x </span>

						<span style="color: #888888">#Assume the left and top corner is (0,0)						</span>
						<span style="color: #008800; font-weight: bold">if</span> ((<span style="color: #007020">abs</span>(area_diff) <span style="color: #333333">&lt;=</span> area_tlr <span style="color: #000000; font-weight: bold">or</span> currentDutyCycleT <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">65000</span>) <span style="color: #000000; font-weight: bold">and</span> <span style="color: #007020">abs</span>(x_diff) <span style="color: #333333">&lt;=</span> x_tlr ):
							c <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
							controller<span style="color: #333333">.</span>set_control( <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>)
						<span style="color: #008800; font-weight: bold">else</span>:
							controller<span style="color: #333333">.</span>set_control( strength_z<span style="color: #333333">*</span><span style="color: #6600EE; font-weight: bold">0.005</span>, strength_x<span style="color: #333333">*</span><span style="color: #6600EE; font-weight: bold">0.05</span>)	<span style="color: #888888">#strength_z*0.005, strength_x*0.05</span>
							<span style="color: #888888"># print(&quot;area didn&#39;t meet the reference&quot;)</span>

						<span style="color: #008800; font-weight: bold">if</span> (y_diff <span style="color: #333333">&lt;=</span> y_tlr):
							<span style="color: #888888"># do nothing within tolerance range</span>
							b <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
						<span style="color: #008800; font-weight: bold">elif</span> (cy <span style="color: #333333">&gt;</span> center_y):
							tilt_lst[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>
							tilt_lst[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">=</span> strength_y
							<span style="color: #888888">##print(&#39;the camera need to raise its head up\n&#39;)</span>

						<span style="color: #008800; font-weight: bold">else</span>:
							tilt_lst[<span style="color: #0000DD; font-weight: bold">0</span>] <span style="color: #333333">=</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>
							tilt_lst[<span style="color: #0000DD; font-weight: bold">1</span>] <span style="color: #333333">=</span> strength_y
							<span style="color: #888888">##print(&#39;the camera need to low its head down\n&#39;)</span>
						length_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time() <span style="color: #333333">-</span> tilt_time
						tilt_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
						last_area <span style="color: #333333">=</span> area
						last_xdiff <span style="color: #333333">=</span> x_diff
						last_ydiff <span style="color: #333333">=</span> y_diff
						last_areaDiff <span style="color: #333333">=</span> area_diff
						<span style="color: #888888"># #print(tilt_lst)</span>
						<span style="color: #888888"># print(send_motor_queue.qsize())</span>
						<span style="color: #888888">#print(tilt_lst)</span>
						<span style="color: #008800; font-weight: bold">if</span> (send_motor_queue<span style="color: #333333">.</span>qsize() <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">2</span>) :
							send_motor_queue<span style="color: #333333">.</span>put(tilt_lst)  <span style="color: #888888"># put mask in queue</span>
							<span style="color: #888888">#print(&quot;send_motor_queue&quot;, send_motor_queue.qsize())</span>
						<span style="color: #888888">#print(&quot;tilt time&quot;, length_time)</span>
						<span style="color: #888888"># print(&quot;processor 2 time &quot;, time.time() - run_time)#print the running time of processor 2</span>
				<span style="color: #008800; font-weight: bold">else</span>:
					<span style="color: #888888">#print(&quot;Processor 2 Didn&#39;t Receive Frame, sleep for 10ms&quot;)</span>
					time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
			<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
				run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
				controller<span style="color: #333333">.</span>clean()
				pi_hw<span style="color: #333333">.</span>stop()


			<span style="color: #888888">##print (&quot;Processor 2 Processing Time: &quot; + str(currentTime_ms-startTime_ms))</span>
		<span style="color: #888888">#print(&quot;Quiting Processor 2&quot;)</span>

	<span style="color: #888888"># Function for the Worker Process 3</span>
	<span style="color: #008800; font-weight: bold">def</span> <span style="color: #0066BB; font-weight: bold">process_motor_3</span>(send_motor_queue, p_start_lock, p_end_lock):
		<span style="color: #008800; font-weight: bold">global</span> count3
		<span style="color: #008800; font-weight: bold">global</span> run_flag
		<span style="color: #888888">#print(&quot;you are there!&quot;)</span>
		<span style="color: #008800; font-weight: bold">while</span> (run_flag<span style="color: #333333">.</span>value):
			run_time <span style="color: #333333">=</span> time<span style="color: #333333">.</span>time()
			<span style="color: #008800; font-weight: bold">try</span>:
				<span style="color: #008800; font-weight: bold">if</span> (<span style="color: #000000; font-weight: bold">not</span> send_motor_queue<span style="color: #333333">.</span>empty()):
					tilt_lst <span style="color: #333333">=</span> send_motor_queue<span style="color: #333333">.</span>get()
					<span style="color: #888888">#print(&quot;get motor queue successfully&quot;)</span>
					count3 <span style="color: #333333">+=</span> <span style="color: #0000DD; font-weight: bold">1</span>
					<span style="color: #888888">#print(&quot;count3  %d&quot; % count3)</span>
					<span style="color: #008800; font-weight: bold">for</span> i <span style="color: #000000; font-weight: bold">in</span> <span style="color: #007020">range</span>(<span style="color: #0000DD; font-weight: bold">1</span>,<span style="color: #0000DD; font-weight: bold">2</span>):
						rotate_camera(tilt_lst[<span style="color: #0000DD; font-weight: bold">0</span>],tilt_lst[<span style="color: #0000DD; font-weight: bold">1</span>]<span style="color: #333333">/</span>i)
						<span style="color: #008800; font-weight: bold">if</span> (<span style="color: #000000; font-weight: bold">not</span> send_motor_queue<span style="color: #333333">.</span>empty()):
							<span style="color: #008800; font-weight: bold">break</span>
						time<span style="color: #333333">.</span>sleep(<span style="color: #0000DD; font-weight: bold">10</span><span style="color: #333333">/</span><span style="color: #6600EE; font-weight: bold">1000.</span>)

				<span style="color: #008800; font-weight: bold">else</span>:
					<span style="color: #888888">#print(&quot;Processor 3 didnt receive the tilt list\n&quot;)</span>
					time<span style="color: #333333">.</span>sleep(<span style="color: #6600EE; font-weight: bold">0.01</span>)
				<span style="color: #888888">##print (&quot;Processor 3 Processing Time: &quot; + str(currentTime_ms-startTime_ms))</span>
				<span style="color: #888888"># print(&quot;processor 3 send command&quot;)</span>
				<span style="color: #888888"># print(&quot;processor 3 time\n\n\n\n &quot;, time.time() - run_time)</span>
			<span style="color: #008800; font-weight: bold">except</span> <span style="color: #FF0000; font-weight: bold">KeyboardInterrupt</span>:
				run_flag<span style="color: #333333">.</span>value <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>

		<span style="color: #888888">#print(&quot;Quiting Processor 3&quot;)</span>

	<span style="color: #888888"># set red thresh </span>
	lower_red <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([<span style="color: #0000DD; font-weight: bold">156</span>,<span style="color: #0000DD; font-weight: bold">100</span>,<span style="color: #0000DD; font-weight: bold">40</span>])
	<span style="color: #888888">#156, 100, 40</span>

	upper_red <span style="color: #333333">=</span> np<span style="color: #333333">.</span>array([<span style="color: #0000DD; font-weight: bold">180</span>,<span style="color: #0000DD; font-weight: bold">255</span>,<span style="color: #0000DD; font-weight: bold">255</span>])

	x_res <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">640</span> <span style="color: #888888">#320 </span>
	y_res <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">480</span> <span style="color: #888888">#240 </span>
	resolution <span style="color: #333333">=</span> x_res<span style="color: #333333">*</span>y_res
	center_x <span style="color: #333333">=</span> x_res<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span>
	center_y <span style="color: #333333">=</span> y_res<span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">2</span>
	area_ref <span style="color: #333333">=</span> resolution<span style="color: #333333">*</span><span style="color: #0000DD; font-weight: bold">4</span><span style="color: #333333">/</span><span style="color: #0000DD; font-weight: bold">5</span>
	tolerance <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">5</span> <span style="color: #333333">/</span> <span style="color: #6600EE; font-weight: bold">100.</span>
	x_tlr <span style="color: #333333">=</span> x_res <span style="color: #333333">*</span> tolerance
	y_tlr <span style="color: #333333">=</span> y_res <span style="color: #333333">*</span> tolerance
	area_tlr <span style="color: #333333">=</span> resolution <span style="color: #333333">*</span> tolerance
	<span style="color: #888888"># Setting Kernel Convolution Parameters</span>
	kernelOpen<span style="color: #333333">=</span>np<span style="color: #333333">.</span>ones((<span style="color: #0000DD; font-weight: bold">5</span>,<span style="color: #0000DD; font-weight: bold">5</span>))
	kernelClose<span style="color: #333333">=</span>np<span style="color: #333333">.</span>ones((<span style="color: #0000DD; font-weight: bold">20</span>,<span style="color: #0000DD; font-weight: bold">20</span>))

	cap <span style="color: #333333">=</span> cv2<span style="color: #333333">.</span>VideoCapture(<span style="color: #0000DD; font-weight: bold">0</span>)
	<span style="color: #888888"># cap.set(3, x_res)</span>
	<span style="color: #888888"># cap.set(4, y_res)</span>

	count1 <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
	count2 <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>
	count3 <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>


	<span style="color: #008800; font-weight: bold">if</span> __name__ <span style="color: #333333">==</span> <span style="background-color: #fff0f0">&#39;__main__&#39;</span>:
		<span style="color: #888888"># run_flag is used to safely exit all processes</span>
		run_flag <span style="color: #333333">=</span> Value(<span style="background-color: #fff0f0">&#39;i&#39;</span>,<span style="color: #0000DD; font-weight: bold">1</span>)
		<span style="color: #888888"># p_start_turn is used to keep worker processes process in order</span>
		p_start_turn <span style="color: #333333">=</span> Value(<span style="background-color: #fff0f0">&#39;i&#39;</span>, <span style="color: #0000DD; font-weight: bold">1</span>)
		p_end_turn <span style="color: #333333">=</span> Value(<span style="background-color: #fff0f0">&#39;i&#39;</span>, <span style="color: #0000DD; font-weight: bold">1</span>)
		send_frame_queue <span style="color: #333333">=</span> Queue()<span style="color: #888888">#send frame to queue </span>
		receive_contour_queue <span style="color: #333333">=</span> Queue()<span style="color: #888888"># send the processed contour to the queue</span>
		send_motor_queue <span style="color: #333333">=</span> Queue()
		p_start_lock <span style="color: #333333">=</span> Lock() <span style="color: #888888">#Safety lock, but didnt use</span>
		p_end_lock <span style="color: #333333">=</span> Lock() <span style="color: #888888">#Safety lock, but didnt use</span>

		p0 <span style="color: #333333">=</span> Process(target<span style="color: #333333">=</span>recognize_balloon, args<span style="color: #333333">=</span>(send_frame_queue, p_start_turn, p_end_turn, p_start_lock, p_end_lock))

		p1 <span style="color: #333333">=</span> Process(target<span style="color: #333333">=</span>process_contour_1, args<span style="color: #333333">=</span>(send_frame_queue, receive_contour_queue, p_start_turn, p_end_turn, p_start_lock, p_end_lock))

		p2 <span style="color: #333333">=</span> Process(target<span style="color: #333333">=</span>calculate_contour_2, args<span style="color: #333333">=</span>(receive_contour_queue, send_motor_queue, p_start_lock, p_end_lock))

		p3 <span style="color: #333333">=</span> Process(target<span style="color: #333333">=</span>process_motor_3, args<span style="color: #333333">=</span>(send_motor_queue, p_start_lock, p_end_lock))


		p0<span style="color: #333333">.</span>start()
		p1<span style="color: #333333">.</span>start()
		p2<span style="color: #333333">.</span>start()
		p3<span style="color: #333333">.</span>start()
		<span style="color: #888888"># Wait for four processes to safely exit</span>
		p0<span style="color: #333333">.</span>join()
		p1<span style="color: #333333">.</span>join()
		p2<span style="color: #333333">.</span>join()
		p3<span style="color: #333333">.</span>join()

		<span style="color: #888888">#Turn off cv2 window</span>
		pi_hw<span style="color: #333333">.</span>hardware_PWM(motorPinT, <span style="color: #0000DD; font-weight: bold">0</span>, <span style="color: #0000DD; font-weight: bold">0</span>) <span style="color: #888888"># 0hz, 0% duty cycle -- stop the motor!</span>
		pi_hw<span style="color: #333333">.</span>stop() <span style="color: #888888"># close pi gpio DMA resources</span>
		cap<span style="color: #333333">.</span>release()
	cv2<span style="color: #333333">.</span>destroyAllWindows()
	</pre></td></tr></table></div>

</div>


<!-- ===================================
=======
	SCRIPTS
==================================== -->
<script src="js/modernizr.min.js"></script>
<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.min.js"></script>
<script src="js/jquery.easing.js"></script>
<script src="js/jquery.scrollUp.min.js"></script>
<script src="js/smooth-scroll.min.js"></script>
<script src="js/jquery.magnific-popup.min.js"></script>
<script src="js/jquery.sliderPro.min.js"></script>
<script src="js/owl.carousel.min.js"></script>
<script src="js/jquery.easypiechart.js"></script>
<script src="js/jquery.countTo.js"></script>
<script src="js/isotope.pkgd.min.js"></script>
<script src="js/jquery.stellar.min.js"></script>
<script src="js/jquery.waypoints.min.js"></script>
<script src="js/wow.min.js"></script>
<script src="js/jquery.nav.js"></script>
<script src="js/custom.js"></script>
</body>
</html>
